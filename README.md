# ubnt‑fwtool

A TypeScript command‑line utility to **inspect, split and build** Ubiquiti UniFi firmware images.

## Why?

* Dig into OEM firmware without juggling C‑sources and cross‑compilers.
* Patch or repack images for custom bootloaders.
* Verify integrity in CI pipelines.

---

## Quick start

```bash
# install (dev‑style)
npm i

# split a firmware into blobs + descriptor
npx ts-node --esm unifi-firmware-tool.ts split XW.v6.3.11.bin -o xw

# list the header + partition table
npx ts-node --esm unifi-firmware-tool.ts list XW.v6.3.11.bin

# verify all CRCs (exit 0 on success, 1 on error)
npx ts-node --esm unifi-firmware-tool.ts verify XW.v6.3.11.bin
```

### Optional RSA check

If your image contains the 256/512‑byte RSA signature block **and**
you have the vendor public key, set the variable below — `verify` will
also validate the signature.

```bash
export UBNT_PUBKEY=keys/ubnt_pub.pem
```

---

## Commands

| Command            | Description                                                                         |
| ------------------ | ----------------------------------------------------------------------------------- |
| `split <img>`      | Extracts all partitions + generates `<prefix>.txt` layout descriptor.               |
| `build <layout>`\* | **(coming back soon)** Re‑assembles a firmware from descriptor + blobs.             |
| `list <img>`       | Human summary table – CRC status, RSA status, sizes.                                |
| `verify <img>`     | Checks header‑CRC, every part CRC, signature CRC & optional RSA; returns exit‑code. |

`* build` was present in earlier versions and returns soon with compression hooks.

---

## Descriptor format (fwsplit compatible)

```
<partName>  <indexHex>  <baseAddrHex>  <partSizeHex>  <memAddrHex>  <entryAddrHex>  <blobFile>
```

Example generated by `split` (`myfw.txt`):

```
uboot      0x00  0x00000000  0x00080000  0x9f000000  0x9f000000  myfw.uboot
kernel0    0x01  0x00080000  0x00f80000  0x9f080000  0x9f080000  myfw.kernel0
```

---

## Example workflow

```bash
# 1. Split stock firmware
npx ts-node --esm unifi-firmware-tool.ts split US.v6.3.11.bin -o custom

# 2. Patch the filesystem blob (squashfs)
unsquashfs custom.kernel0
# … modify files …
mksquashfs squashfs-root custom.kernel0 -noappend -comp lzma

# 3. (Soon) rebuild
# npx ts-node --esm unifi-firmware-tool.ts build custom.txt -o custom.bin -v "US.v6.3.11-patched"
```

---

## Development

```bash
# Type‑check
npx tsc --noEmit

# Run Jest round‑trip tests (split -> build -> byte compare)
npm test
```

---

## Roadmap ✨

* Streaming build for huge images.
* Compression hooks (lzma/zstd per part).
* Differential patch image generator.
* Stand‑alone binary via `pkg`.
